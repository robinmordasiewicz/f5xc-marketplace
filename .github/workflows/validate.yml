---
name: Validate Marketplace

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

jobs:
  lint:
    name: Lint & Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install linting tools
        run: |
          pip install ruff mypy yamllint check-jsonschema
          npm install -g markdownlint-cli2

      - name: Python - Ruff Lint
        run: ruff check --output-format=github scripts/

      - name: Python - Ruff Format Check
        run: ruff format --check scripts/

      - name: Python - Type Check (mypy)
        run: mypy scripts/ --strict

      - name: YAML - Lint
        run: yamllint --strict -c .yamllint.yml .

      - name: JSON - Schema Validation
        run: |
          check-jsonschema \
            --schemafile schemas/marketplace.schema.json \
            .claude-plugin/marketplace.json

      - name: Markdown - Lint
        run: markdownlint-cli2 --config .markdownlint-cli2.jsonc

  validate:
    name: Validate Marketplace
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate marketplace.json exists
        run: |
          if [ ! -f ".claude-plugin/marketplace.json" ]; then
            echo "::error::Missing .claude-plugin/marketplace.json"
            exit 1
          fi
          echo "✓ marketplace.json exists"

      - name: Validate marketplace.json syntax
        run: |
          python3 -m json.tool .claude-plugin/marketplace.json > /dev/null
          echo "✓ marketplace.json is valid JSON"

      - name: Validate required files exist
        run: |
          ERRORS=0

          if [ ! -f "LICENSE" ]; then
            echo "::error::Missing LICENSE file"
            ERRORS=$((ERRORS + 1))
          else
            echo "✓ LICENSE file exists"
          fi

          if [ ! -f "CHANGELOG.md" ]; then
            echo "::error::Missing CHANGELOG.md file"
            ERRORS=$((ERRORS + 1))
          else
            echo "✓ CHANGELOG.md exists"
          fi

          if [ $ERRORS -gt 0 ]; then
            exit 1
          fi

      - name: Validate required marketplace fields
        run: |
          python3 << 'EOF'
          import json
          import sys

          with open('.claude-plugin/marketplace.json') as f:
              data = json.load(f)

          required_fields = ['name', 'version', 'description', 'license', 'owner', 'plugins']
          errors = []

          for field in required_fields:
              if field not in data:
                  errors.append(f"Missing required field: {field}")

          if 'owner' in data:
              if 'name' not in data['owner']:
                  errors.append("Missing owner.name field")

          if errors:
              for error in errors:
                  print(f"::error::{error}")
              sys.exit(1)

          print("✓ All required marketplace fields present")
          EOF

      - name: Validate plugins have required fields
        run: |
          python3 << 'EOF'
          import json
          import sys

          with open('.claude-plugin/marketplace.json') as f:
              data = json.load(f)

          plugins = data.get('plugins', [])
          required_fields = ['name', 'description', 'source']
          errors = []

          for i, plugin in enumerate(plugins):
              for field in required_fields:
                  if field not in plugin:
                      errors.append(f"Plugin '{plugin.get('name', f'index {i}')}' missing field: {field}")

              # Validate source structure
              source = plugin.get('source', {})
              if isinstance(source, dict):
                  if 'source' not in source or 'repo' not in source:
                      errors.append(f"Plugin '{plugin.get('name')}' has invalid source structure")

          if errors:
              for error in errors:
                  print(f"::error::{error}")
              sys.exit(1)

          for plugin in plugins:
              print(f"✓ Plugin '{plugin['name']}' validated")
          EOF

      - name: Validate plugin sources are accessible
        run: |
          python3 << 'EOF'
          import json
          import urllib.request
          import sys

          with open('.claude-plugin/marketplace.json') as f:
              data = json.load(f)

          errors = []
          for plugin in data.get('plugins', []):
              source = plugin.get('source', {})
              if isinstance(source, dict) and source.get('source') == 'github':
                  repo = source.get('repo', '')
                  url = f"https://api.github.com/repos/{repo}"
                  try:
                      req = urllib.request.Request(url, headers={'User-Agent': 'Mozilla/5.0'})
                      urllib.request.urlopen(req, timeout=10)
                      print(f"✓ Plugin '{plugin['name']}' source accessible: {repo}")
                  except urllib.error.HTTPError as e:
                      if e.code == 404:
                          errors.append(f"Plugin '{plugin['name']}' source not found: {repo}")
                      else:
                          errors.append(f"Plugin '{plugin['name']}' source error ({e.code}): {repo}")
                  except Exception as e:
                      errors.append(f"Plugin '{plugin['name']}' source check failed: {e}")

          if errors:
              for error in errors:
                  print(f"::error::{error}")
              sys.exit(1)

          print("\n✓ All plugin sources accessible")
          EOF

      - name: Summary
        run: |
          echo ""
          echo "=== Marketplace Validation Summary ==="
          python3 << 'EOF'
          import json

          with open('.claude-plugin/marketplace.json') as f:
              data = json.load(f)

          print(f"Marketplace: {data.get('name')}")
          print(f"Version: {data.get('version')}")
          print(f"License: {data.get('license')}")
          print(f"Plugins: {len(data.get('plugins', []))}")
          for plugin in data.get('plugins', []):
              print(f"  - {plugin['name']} v{plugin.get('version', 'N/A')}")
          EOF
          echo "======================================="
          echo "✓ All validations passed"

  docs-test:
    name: Documentation Build Test
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          pip install mkdocs-material mkdocs-minify-plugin
          npm install -g markdownlint-cli2

      - name: Generate plugin documentation
        run: python scripts/generate-plugin-docs.py

      - name: Validate generated markdown
        run: markdownlint-cli2 "docs/plugins/*.md" --config .markdownlint-cli2.jsonc

      - name: Build documentation (strict mode)
        run: mkdocs build --strict

      - name: Verify build output
        run: |
          if [ ! -d "site" ]; then
            echo "::error::Documentation build failed - site directory not created"
            exit 1
          fi
          if [ ! -f "site/index.html" ]; then
            echo "::error::Documentation build failed - index.html not generated"
            exit 1
          fi
          echo "✓ Documentation build successful"
          echo "Generated files:"
          find site -type f -name "*.html" | head -20
